name: Benchmark

on:
  pull_request:
    types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  LANG: C.UTF-8
  LC_ALL: C.UTF-8

jobs:
  benchmark:
    name: Run benchmark (${{ matrix.branch }})
    if: github.event.label.name == 'bench'
    runs-on: u22-arm-runner
    strategy:
      fail-fast: false
      matrix:
        branch: [main, pr]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch == 'main' && 'main' || github.event.pull_request.head.sha }}

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: "27.2.1"
          elixir-version: "1.18.2"

      - name: Cache Mix dependencies
        uses: actions/cache@v4
        with:
          path: deps
          key: ${{ runner.os }}-mix-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check available perf packages
        run: |
          echo "Kernel version:"
          uname -r
          echo ""
          echo "Available linux-tools packages:"
          sudo apt-get update
          apt-cache search linux-tools | sort

      - name: Build release
        run: METRICS_DISABLED=false make prod_rel

      - name: Install pgbench, perf and FlameGraph tools
        run: |
          sudo apt-get install -y postgresql-contrib
          sudo apt-get install -y linux-tools-common linux-tools-generic
          git clone https://github.com/brendangregg/FlameGraph.git /tmp/FlameGraph

      - name: Start PostgreSQL
        run: |
          docker-compose -f docker-compose.db.yml up -d
          # Wait for PostgreSQL to be ready
          timeout 30 bash -c 'until docker exec supavisor-db pg_isready -U postgres; do sleep 1; done'

      - name: Initialize TPCC database
        run: |
          PGPASSWORD=postgres pgbench -i -h 127.0.0.1 -p 6432 -U postgres -d postgres

      - name: Start Supavisor release
        run: |
          export SUPAVISOR_LOG_FILE_PATH=/tmp/supavisor.log
          make prod_start_daemon
          sleep 10

      - name: Create tenant for benchmark
        run: |
          curl -X PUT \
            'http://localhost:4000/api/tenants/sys' \
            --header 'Accept: application/json' \
            --header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNjQ1MTkyODI0LCJleHAiOjE5NjA3Njg4MjR9.M9jrxyvPLkUxWgOYSf5dNdJ8v_eRrq810ShFRT8N-6M' \
            --header 'Content-Type: application/json' \
            --data-raw '{
            "tenant": {
              "db_host": "localhost",
              "db_port": 6432,
              "db_database": "postgres",
              "ip_version": "auto",
              "enforce_ssl": false,
              "require_user": false,
              "auth_query": "SELECT rolname, rolpassword FROM pg_authid WHERE rolname=$1;",
              "users": [
                {
                  "db_user": "postgres",
                  "db_password": "postgres",
                  "pool_size": 20,
                  "mode_type": "transaction",
                  "is_manager": true
                }
              ]
            }
          }'

          echo ""
          sleep 2
          echo "Supavisor logs:"
          cat /tmp/supavisor.log

      - name: Run vanilla TPCC benchmark
        run: |
          set +e
          PGPASSWORD=postgres pgbench \
            postgres://postgres.sys@localhost:6543/postgres?sslmode=disable \
            -S -n -T 30 \
            -j 8 -c 30 \
            -P 10 -M extended \
            > ${{ matrix.branch }}-vanilla-results.txt 2>&1
          BENCH_EXIT=$?
          set -e

          cat ${{ matrix.branch }}-vanilla-results.txt
          exit $BENCH_EXIT

      - name: Run TPCC benchmark with perf
        run: |
          set +e
          # Get BEAM PID
          BEAM_PID=$(pgrep -f "beam.smp")
          echo "BEAM PID: $BEAM_PID"

          # Start perf recording in background
          sudo perf record -F 99 -p $BEAM_PID --call-graph dwarf -o ${{ matrix.branch }}-perf.data -- sleep 30 &
          PERF_PID=$!

          # Run benchmark
          PGPASSWORD=postgres pgbench \
            postgres://postgres.sys@localhost:6543/postgres?sslmode=disable \
            -S -n -T 30 \
            -j 8 -c 30 \
            -P 10 -M extended \
            > ${{ matrix.branch }}-perf-results.txt 2>&1
          BENCH_EXIT=$?

          # Wait for perf to finish
          wait $PERF_PID
          set -e

          cat ${{ matrix.branch }}-perf-results.txt
          exit $BENCH_EXIT

      - name: Generate flamegraph
        run: |
          sudo perf script -i ${{ matrix.branch }}-perf.data | \
            /tmp/FlameGraph/stackcollapse-perf.pl | \
            /tmp/FlameGraph/flamegraph.pl > ${{ matrix.branch }}-flamegraph.svg

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.branch }}-benchmark-results
          path: |
            ${{ matrix.branch }}-vanilla-results.txt
            ${{ matrix.branch }}-perf-results.txt
            ${{ matrix.branch }}-flamegraph.svg

      - name: Stop Supavisor
        if: always()
        run: |
          _build/prod/rel/supavisor/bin/supavisor stop || true

      - name: Stop PostgreSQL
        if: always()
        run: |
          docker-compose -f docker-compose.db.yml down

  report:
    name: Post benchmark results
    needs: benchmark
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Download main results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: main-benchmark-results
          path: main-results

      - name: Download PR results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: pr-benchmark-results
          path: pr-results

      - name: Read benchmark results
        id: results
        run: |
          echo "MAIN_VANILLA<<EOF" >> $GITHUB_OUTPUT
          if [ -f main-results/main-vanilla-results.txt ]; then
            cat main-results/main-vanilla-results.txt >> $GITHUB_OUTPUT
          else
            echo "Benchmark failed - no results available" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

          echo "MAIN_PERF<<EOF" >> $GITHUB_OUTPUT
          if [ -f main-results/main-perf-results.txt ]; then
            cat main-results/main-perf-results.txt >> $GITHUB_OUTPUT
          else
            echo "Benchmark failed - no results available" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

          echo "PR_VANILLA<<EOF" >> $GITHUB_OUTPUT
          if [ -f pr-results/pr-vanilla-results.txt ]; then
            cat pr-results/pr-vanilla-results.txt >> $GITHUB_OUTPUT
          else
            echo "Benchmark failed - no results available" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

          echo "PR_PERF<<EOF" >> $GITHUB_OUTPUT
          if [ -f pr-results/pr-perf-results.txt ]; then
            cat pr-results/pr-perf-results.txt >> $GITHUB_OUTPUT
          else
            echo "Benchmark failed - no results available" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Encode flamegraphs as base64
        id: flamegraphs
        run: |
          echo "MAIN_FLAME<<EOF" >> $GITHUB_OUTPUT
          if [ -f main-results/main-flamegraph.svg ]; then
            base64 -w 0 main-results/main-flamegraph.svg >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

          echo "PR_FLAME<<EOF" >> $GITHUB_OUTPUT
          if [ -f pr-results/pr-flamegraph.svg ]; then
            base64 -w 0 pr-results/pr-flamegraph.svg >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const mainFlameB64 = '${{ steps.flamegraphs.outputs.MAIN_FLAME }}';
            const prFlameB64 = '${{ steps.flamegraphs.outputs.PR_FLAME }}';

            const mainFlame = mainFlameB64 ? Buffer.from(mainFlameB64, 'base64').toString('utf-8') : '';
            const prFlame = prFlameB64 ? Buffer.from(prFlameB64, 'base64').toString('utf-8') : '';

            let comment = `## Benchmark Results

            ### Main Branch

            #### Vanilla TPCC Select-Only (30s)
            \`\`\`
            ${{ steps.results.outputs.MAIN_VANILLA }}
            \`\`\`

            #### With Perf
            \`\`\`
            ${{ steps.results.outputs.MAIN_PERF }}
            \`\`\`
            `;

            if (mainFlame) {
              comment += `
            <details>
            <summary>Main Branch Flamegraph</summary>

            ${mainFlame}

            </details>
            `;
            }

            comment += `
            ---

            ### PR Branch

            #### Vanilla TPCC Select-Only (30s)
            \`\`\`
            ${{ steps.results.outputs.PR_VANILLA }}
            \`\`\`

            #### With Perf
            \`\`\`
            ${{ steps.results.outputs.PR_PERF }}
            \`\`\`
            `;

            if (prFlame) {
              comment += `
            <details>
            <summary>PR Branch Flamegraph</summary>

            ${prFlame}

            </details>`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
